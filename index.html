<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./style.css" />
  <title>QR Profe â€” Registro</title>
</head>

<body>
  <header class="topbar">
    <div>
      <h1 class="brand">QR Profe â€” Registro</h1>
      <div class="sub">Offline-first â€¢ Escaneo rÃ¡pido â€¢ SincronizaciÃ³n por lote</div>
    </div>
    <div class="device-pill">
      <span class="dot"></span>
      <span id="deviceLabel">Dispositivo: â€”</span>
    </div>
  </header>

  <main class="wrap">

    <!-- 0) Contexto -->
    <section class="card context-card">
      <div class="card-title">
        <span>0) Contexto de sesiÃ³n</span>
        <div class="btns">
          <button id="btnAlistar" class="primary">âœ… Alistar</button>
          <button id="btnBorrarCtx">ğŸ§¹ Borrar</button>
        </div>
      </div>

      <div class="small" style="margin-bottom:10px;color:#a9b7d6;">
        Elige Asignatura/Grupo y Hora-clase inicio (1â€“8).
      </div>

      <div class="row" style="gap:15px; flex-wrap:wrap;">
        <div class="field" style="flex:1; min-width: 160px;">
          <label for="contextoClase">Asignatura / Grupo</label>
          <select id="contextoClase" class="input-std">
            <option value="">â€” Seleccionar â€”</option>
            <option value="EconomÃ­a 11Â°A">EconomÃ­a 11Â°A</option>
            <option value="EconomÃ­a 11Â°B">EconomÃ­a 11Â°B</option>
            <option value="FilosofÃ­a 11Â°A">FilosofÃ­a 11Â°A</option>
            <option value="FilosofÃ­a 11Â°B">FilosofÃ­a 11Â°B</option>
            <option value="EconomÃ­a 10Â°A">EconomÃ­a 10Â°A</option>
            <option value="FilosofÃ­a 10Â°A">FilosofÃ­a 10Â°A</option>
            <option value="C. Sociales 6Â°A">C. Sociales 6Â°A</option>
            <option value="C. Sociales 6Â°B">C. Sociales 6Â°B</option>
            <option value="C. Sociales POS">C. Sociales POS</option>
            <option value="EVENTO">Evento / Izada Bandera</option>
          </select>
        </div>

        <div class="field" style="flex:1; min-width: 160px;">
          <label for="horaClaseInicio">Hora-clase inicio</label>
          <select id="horaClaseInicio" class="input-std">
            <option value="">â€” Seleccionar â€”</option>
            <option value="1">1Â° (07:00 - 07:54)</option>
            <option value="2">2Â° (07:54 - 08:48)</option>
            <option value="3">3Â° (08:48 - 09:42)</option>
            <option value="4">4Â° (09:52 - 10:46)</option>
            <option value="5">5Â° (10:46 - 11:40)</option>
            <option value="6">6Â° (12:06 - 13:00)</option>
            <option value="7">7Â° (13:00 - 13:54)</option>
            <option value="8">8Â° (13:54 - 14:48)</option>
          </select>
        </div>
      </div>

      <div class="ctx-preview" id="ctxPreview" style="margin-top:12px;">
        <div><span class="muted">Asignatura:</span> <span id="ctxPreviewAsig">â€”</span></div>
        <div><span class="muted">Inicio:</span> <span id="ctxPreviewBloq">â€”</span></div>
        <div><span class="muted">T0 -</span> <span id="ctxPreviewT0">â€”</span></div>
      </div>
    </section>

    <!-- 1) Escaneo -->
    <section class="card">
      <div class="card-title">1) Escaneo y registro</div>

      <div class="btns">
        <button id="scanBtn" class="primary">ğŸ“¸ Escanear QR</button>
        <button id="cancelScanBtn" style="display:none;">â¹ï¸ Detener</button>
      </div>

      <div id="notice" class="notice" style="margin-top:10px;">
        <strong>Listo.</strong> Selecciona contexto (opcional) y escanea.
      </div>

      <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
        <div class="pill" id="codigoActual">CÃ³digo: â€”</div>
        <div class="pill" id="horaActual">Hora: â€”</div>
      </div>

      <div id="qr-reader" class="qr-reader" style="display:none; margin-top:14px;"></div>

      <div id="formEvento" class="form" style="display:none; margin-top:14px;">
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div class="field" style="flex:1; min-width:160px;">
            <label for="tipo">Tipo de registro</label>
            <select id="tipo" class="input-std">
              <option value="INASISTENCIA">INASISTENCIA</option>
              <option value="TARDE">TARDE</option>
              <option value="CONVIVENCIA">CONVIVENCIA</option>
            </select>
          </div>

          <div id="wrapExcusa" class="field" style="flex:1; min-width:160px;">
            <label for="excusa">Excusa</label>
            <select id="excusa" class="input-std">
              <option value="SIN_EXCUSA">Sin excusa</option>
              <option value="CON_EXCUSA">Con excusa</option>
            </select>
          </div>

          <div id="wrapNivel" class="field" style="flex:1; min-width:160px; display:none;">
            <label for="nivel">ClasificaciÃ³n</label>
            <select id="nivel" class="input-std">
              <option value="TIPO_I">Tipo I</option>
              <option value="TIPO_II">Tipo II</option>
              <option value="TIPO_III">Tipo III</option>
            </select>
          </div>

          <div id="wrapFalta" class="field" style="flex:1; min-width:240px; display:none;">
            <label for="falta">Falta</label>
            <select id="falta" class="input-std">
              <option value="">â€” seleccionar â€”</option>
            </select>
          </div>
        </div>

        <div id="wrapFaltaOtra" class="field" style="display:none; margin-top:10px;">
          <label for="faltaOtra">Otra falta (guardar nueva)</label>
          <input id="faltaOtra" class="input-std" placeholder="Escribe la falta..." />
        </div>

        <div id="wrapObsTipo" class="field" style="display:none; margin-top:10px;">
          <label for="obsTipo">ObservaciÃ³n tipo (Tarde)</label>
          <select id="obsTipo" class="input-std">
            <option value="">â€” seleccionar â€”</option>
            <option value="_OTRA">Otra (escribir abajo)</option>
          </select>
        </div>

        <div class="field" style="margin-top:10px;">
          <label for="obs">ObservaciÃ³n</label>
          <input id="obs" class="input-std" placeholder="Detalle breve (opcional)..." />
        </div>

        <div class="btns" style="margin-top:12px;">
          <button id="guardarBtn" class="primary">ğŸ’¾ Guardar</button>
        </div>
      </div>
    </section>

    <!-- 2) Acciones e historial -->
    <section class="card">
      <div class="card-title">2) Historial y acciones</div>

      <!-- ğŸ”§ Cambio: forzar una sola lÃ­nea -->
      <div class="btns actions-bar">
        <!-- ğŸ”§ Cambio: texto corto -->
        <button id="syncBtn">â˜ï¸ Sincronizar GS</button>
        <button id="exportarBtn">â¬‡ï¸ Exportar CSV</button>
        <button id="limpiarBtn" class="danger">ğŸ§¹ Limpiar</button>
      </div>

      <div class="small muted" style="margin-top:10px;">
        Registros en dispositivo: <span id="totalReg">0</span>
      </div>

      <div id="historial" class="historial" style="margin-top:10px;"></div>
    </section>

  </main>

  <script src="./html5-qrcode.min.js"></script>

  <script>
    (function(){
      const KEY_CTX = "qr_contexto_sesion_v1";
      const BLOQUE_T0 = {
        "1":"07:00:00",
        "2":"07:54:00",
        "3":"08:48:00",
        "4":"09:52:00",
        "5":"10:46:00",
        "6":"12:06:00",
        "7":"13:00:00",
        "8":"13:54:00"
      };

      const selAsig = document.getElementById("contextoClase");
      const selBloq = document.getElementById("horaClaseInicio");
      const btn = document.getElementById("btnAlistar");
      const btnClear = document.getElementById("btnBorrarCtx");

      const pAsig = document.getElementById("ctxPreviewAsig");
      const pBloq = document.getElementById("ctxPreviewBloq");
      const pT0 = document.getElementById("ctxPreviewT0");

      let locked = false;

      function safeParseJSON(raw, fallback){
        try{ const v = JSON.parse(raw); return v ?? fallback; }catch{ return fallback; }
      }

      function refreshPreview(){
        const asig = (selAsig.value || "").trim();
        const bloque = (selBloq.value || "").trim();
        const t0 = BLOQUE_T0[bloque] || "";

        pAsig.textContent = asig || "â€”";
        pBloq.textContent = bloque ? (selBloq.options[selBloq.selectedIndex].textContent || bloque) : "â€”";
        pT0.textContent = t0 ? (t0 + " (" + (t0) + ")") : "â€”";
      }

      function setLocked(v){
        locked = !!v;
        if (selAsig) selAsig.disabled = locked;
        if (selBloq) selBloq.disabled = locked;

        if (btn){
          btn.textContent = locked ? "ğŸ”“ Cambiar" : "âœ… Alistar";
        }
      }

      function persistContext(){
        const asignatura = (selAsig.value || "").trim();
        const bloque = (selBloq.value || "").trim();

        if(!asignatura || !bloque){
          return false;
        }

        const bloqueLabel = (selBloq.options[selBloq.selectedIndex] || {}).textContent || bloque;

        try{
          localStorage.setItem(KEY_CTX, JSON.stringify({
            asignatura,
            bloque,
            bloqueLabel: String(bloqueLabel || "").trim(),
            updatedAt: new Date().toISOString(),
            locked: locked
          }));
        }catch{}
        return true;
      }

      function cargarContexto(){
        const raw = localStorage.getItem(KEY_CTX);
        const ctx = raw ? safeParseJSON(raw, null) : null;

        if(ctx && ctx.asignatura && ctx.bloque){
          selAsig.value = ctx.asignatura;
          selBloq.value = String(ctx.bloque);
        }

        refreshPreview();
        setLocked(!!(ctx && ctx.locked));
      }

      selAsig && selAsig.addEventListener("change", refreshPreview);
      selBloq && selBloq.addEventListener("change", refreshPreview);

      // âœ… Alistar / ğŸ”“ Cambiar
      btn && btn.addEventListener("click", () => {
        // Si estÃ¡ fijado, pasamos a modo ediciÃ³n (desbloquear) sin borrar el contexto
        if(locked){
          setLocked(false);
          // Persistimos estado desbloqueado
          const raw = localStorage.getItem(KEY_CTX);
          const ctx = raw ? safeParseJSON(raw, null) : null;
          if(ctx){
            try{
              localStorage.setItem(KEY_CTX, JSON.stringify({
                ...ctx,
                locked: false,
                updatedAt: new Date().toISOString()
              }));
            }catch{}
          }
          return;
        }

        // Si NO estÃ¡ fijado: validamos y fijamos
        const asignatura = (selAsig.value || "").trim();
        const bloque = (selBloq.value || "").trim();
        if(!asignatura || !bloque){
          alert("Debes seleccionar Asignatura/Grupo y Hora-clase inicio.");
          return;
        }

        // Guardar + Fijar (bloquear selects)
        setLocked(true);
        persistContext();
        refreshPreview();
      });

      // ğŸ§¹ Borrar contexto
      btnClear && btnClear.addEventListener("click", () => {
        const ok = confirm("Â¿Borrar el contexto de sesiÃ³n?\n\nEsto NO elimina registros guardados.");
        if(!ok) return;

        try{ localStorage.removeItem(KEY_CTX); }catch{}

        setLocked(false);

        // Reset selects
        if(selAsig) selAsig.value = "";
        if(selBloq) selBloq.value = "";

        refreshPreview();
      });

      cargarContexto();
    })();
  </script>

  <!-- App principal -->
  <script src="./app.20260212-07.js?v=ctxfix2"></script>
</body>
</html>
