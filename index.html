<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./style.css" />
  <title>QR Profe ‚Äî Registro</title>

  <!-- ‚úÖ SOLO DISE√ëO (no toca l√≥gica): t√≠tulo m√°s peque√±o + barra de acciones en una l√≠nea -->
  <style>
    /* 1) T√≠tulo principal: m√°s peque√±o y SIN salto de l√≠nea */
    .topbar .brand{
      margin: 0;
      font-size: clamp(26px, 6.2vw, 34px);
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 2) Barra de acciones: 3 botones en una sola l√≠nea */
    .btns.actions-bar{
      display: flex;
      flex-wrap: nowrap;
      gap: 10px;
      align-items: stretch;
    }
    .btns.actions-bar button{
      flex: 1 1 0;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 10px 8px;
      font-size: 14px;
    }

    /* Ajuste extra para pantallas muy angostas */
    @media (max-width: 380px){
      .btns.actions-bar{ gap: 8px; }
      .btns.actions-bar button{
        padding: 9px 6px;
        font-size: 13px;
      }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div>
      <h1 class="brand">QR Profe ‚Äî Registro</h1>
      <div class="sub">Offline-first ‚Ä¢ Escaneo r√°pido ‚Ä¢ Sincronizaci√≥n por lote</div>
    </div>
    <div class="device-pill">
      <span class="dot"></span>
      <span id="deviceLabel">Dispositivo: ‚Äî</span>
    </div>
  </header>

  <main class="wrap">

    <!-- 0) Contexto -->
    <section class="card context-card">
      <div class="card-title">
        <span>0) Contexto de sesi√≥n</span>
        <div class="btns">
          <button id="btnAlistar" class="primary">‚úÖ Alistar</button>
          <button id="btnBorrarCtx">üßπ Borrar</button>
        </div>
      </div>

      <div class="small" style="margin-bottom:10px;color:#a9b7d6;">
        Elige Asignatura/Grupo y Hora-clase inicio (1‚Äì8).
      </div>

      <div class="row" style="gap:15px; flex-wrap:wrap;">
        <div class="field" style="flex:1; min-width: 160px;">
          <label for="contextoClase">Asignatura / Grupo</label>
          <select id="contextoClase" class="input-std">
            <option value="">‚Äî Seleccionar ‚Äî</option>
            <option value="Econom√≠a 11¬∞A">Econom√≠a 11¬∞A</option>
            <option value="Econom√≠a 11¬∞B">Econom√≠a 11¬∞B</option>
            <option value="Filosof√≠a 11¬∞A">Filosof√≠a 11¬∞A</option>
            <option value="Filosof√≠a 11¬∞B">Filosof√≠a 11¬∞B</option>
            <option value="Econom√≠a 10¬∞A">Econom√≠a 10¬∞A</option>
            <option value="Filosof√≠a 10¬∞A">Filosof√≠a 10¬∞A</option>
            <option value="C. Sociales 6¬∞A">C. Sociales 6¬∞A</option>
            <option value="C. Sociales 6¬∞B">C. Sociales 6¬∞B</option>
            <option value="C. Sociales POS">C. Sociales POS</option>
            <option value="EVENTO">Evento / Izada Bandera</option>
          </select>
        </div>

        <div class="field" style="flex:1; min-width: 160px;">
          <label for="horaClaseInicio">Hora-clase inicio</label>
          <select id="horaClaseInicio" class="input-std">
            <option value="">‚Äî Seleccionar ‚Äî</option>
            <option value="1">1¬∞ (07:00 - 07:54)</option>
            <option value="2">2¬∞ (07:54 - 08:48)</option>
            <option value="3">3¬∞ (08:48 - 09:42)</option>
            <option value="4">4¬∞ (09:52 - 10:46)</option>
            <option value="5">5¬∞ (10:46 - 11:40)</option>
            <option value="6">6¬∞ (12:06 - 13:00)</option>
            <option value="7">7¬∞ (13:00 - 13:54)</option>
            <option value="8">8¬∞ (13:54 - 14:48)</option>
          </select>
        </div>
      </div>

      <div class="ctx-preview" id="ctxPreview" style="margin-top:12px;">
        <div><span class="muted">Asignatura:</span> <span id="ctxPreviewAsig">‚Äî</span></div>
        <div><span class="muted">Inicio:</span> <span id="ctxPreviewBloq">‚Äî</span></div>
        <div><span class="muted">T0 -</span> <span id="ctxPreviewT0">‚Äî</span></div>
      </div>
    </section>

    <!-- 1) Escaneo -->
    <section class="card">
      <div class="card-title">1) Escaneo y registro</div>

      <div class="btns">
        <button id="scanBtn" class="primary">üì∏ Escanear QR</button>
        <button id="cancelScanBtn" style="display:none;">‚èπÔ∏è Detener</button>
      </div>

      <div id="notice" class="notice" style="margin-top:10px;">
        <strong>Listo.</strong> Selecciona contexto (opcional) y escanea.
      </div>

      <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
        <div class="pill" id="codigoActual">C√≥digo: ‚Äî</div>
        <div class="pill" id="horaActual">Hora: ‚Äî</div>
      </div>

      <div id="qr-reader" class="qr-reader" style="display:none; margin-top:14px;"></div>

      <div id="formEvento" class="form" style="display:none; margin-top:14px;">
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div class="field" style="flex:1; min-width:160px;">
            <label for="tipo">Tipo de registro</label>
            <select id="tipo" class="input-std">
              <option value="INASISTENCIA">INASISTENCIA</option>
              <option value="TARDE">TARDE</option>
              <option value="CONVIVENCIA">CONVIVENCIA</option>
            </select>
          </div>

          <div id="wrapExcusa" class="field" style="flex:1; min-width:160px;">
            <label for="excusa">Excusa</label>
            <select id="excusa" class="input-std">
              <option value="SIN_EXCUSA">Sin excusa</option>
              <option value="CON_EXCUSA">Con excusa</option>
            </select>
          </div>

          <div id="wrapNivel" class="field" style="flex:1; min-width:160px; display:none;">
            <label for="nivel">Clasificaci√≥n</label>
            <select id="nivel" class="input-std">
              <option value="TIPO_I">Tipo I</option>
              <option value="TIPO_II">Tipo II</option>
              <option value="TIPO_III">Tipo III</option>
            </select>
          </div>

          <div id="wrapFalta" class="field" style="flex:1; min-width:240px; display:none;">
            <label for="falta">Falta</label>
            <select id="falta" class="input-std">
              <option value="">‚Äî seleccionar ‚Äî</option>
            </select>
          </div>
        </div>

        <div id="wrapFaltaOtra" class="field" style="display:none; margin-top:10px;">
          <label for="faltaOtra">Otra falta (guardar nueva)</label>
          <input id="faltaOtra" class="input-std" placeholder="Escribe la falta..." />
        </div>

        <div id="wrapObsTipo" class="field" style="display:none; margin-top:10px;">
          <label for="obsTipo">Observaci√≥n tipo (Tarde)</label>
          <select id="obsTipo" class="input-std">
            <option value="">‚Äî seleccionar ‚Äî</option>
            <option value="_OTRA">Otra (escribir abajo)</option>
          </select>
        </div>

        <div class="field" style="margin-top:10px;">
          <label for="obs">Observaci√≥n</label>
          <input id="obs" class="input-std" placeholder="Detalle breve (opcional)..." />
        </div>

        <div class="btns" style="margin-top:12px;">
          <button id="guardarBtn" class="primary">üíæ Guardar</button>
        </div>
      </div>
    </section>

    <!-- 2) Acciones e historial -->
    <section class="card">
      <div class="card-title">2) Historial y acciones</div>

      <!-- ‚úÖ Una sola l√≠nea -->
      <div class="btns actions-bar">
        <button id="syncBtn">‚òÅÔ∏è Sincronizar GS</button>
        <button id="exportarBtn">‚¨áÔ∏è Exportar CSV</button>
        <button id="limpiarBtn" class="danger">üßπ Limpiar</button>
      </div>

      <div class="small muted" style="margin-top:10px;">
        Registros en dispositivo: <span id="totalReg">0</span>
      </div>

      <div id="historial" class="historial" style="margin-top:10px;"></div>
    </section>

  </main>

  <script src="./html5-qrcode.min.js"></script>

  <script>
    (function(){
      const KEY_CTX = "qr_contexto_sesion_v1";
      const BLOQUE_T0 = {
        "1":"07:00:00",
        "2":"07:54:00",
        "3":"08:48:00",
        "4":"09:52:00",
        "5":"10:46:00",
        "6":"12:06:00",
        "7":"13:00:00",
        "8":"13:54:00"
      };

      const selAsig = document.getElementById("contextoClase");
      const selBloq = document.getElementById("horaClaseInicio");
      const btn = document.getElementById("btnAlistar");
      const btnClear = document.getElementById("btnBorrarCtx");

      const pAsig = document.getElementById("ctxPreviewAsig");
      const pBloq = document.getElementById("ctxPreviewBloq");
      const pT0 = document.getElementById("ctxPreviewT0");

      let locked = false;

      function safeParseJSON(raw, fallback){
        try{ const v = JSON.parse(raw); return v ?? fallback; }catch{ return fallback; }
      }

      function refreshPreview(){
        const asig = (selAsig.value || "").trim();
        const bloque = (selBloq.value || "").trim();
        const t0 = BLOQUE_T0[bloque] || "";

        pAsig.textContent = asig || "‚Äî";
        pBloq.textContent = bloque ? (selBloq.options[selBloq.selectedIndex].textContent || bloque) : "‚Äî";
        pT0.textContent = t0 ? (t0 + " (" + (t0) + ")") : "‚Äî";
      }

      function setLocked(v){
        locked = !!v;
        if (selAsig) selAsig.disabled = locked;
        if (selBloq) selBloq.disabled = locked;

        if (btn){
          btn.textContent = locked ? "üîì Cambiar" : "‚úÖ Alistar";
        }
      }

      function persistContext(){
        const asignatura = (selAsig.value || "").trim();
        const bloque = (selBloq.value || "").trim();

        if(!asignatura || !bloque){
          return false;
        }

        const bloqueLabel = (selBloq.options[selBloq.selectedIndex] || {}).textContent || bloque;

        try{
          localStorage.setItem(KEY_CTX, JSON.stringify({
            asignatura,
            bloque,
            bloqueLabel: String(bloqueLabel || "").trim(),
            updatedAt: new Date().toISOString(),
            locked: locked
          }));
        }catch{}
        return true;
      }

      function cargarContexto(){
        const raw = localStorage.getItem(KEY_CTX);
        const ctx = raw ? safeParseJSON(raw, null) : null;

        if(ctx && ctx.asignatura && ctx.bloque){
          selAsig.value = ctx.asignatura;
          selBloq.value = String(ctx.bloque);
        }

        refreshPreview();
        setLocked(!!(ctx && ctx.locked));
      }

      selAsig && selAsig.addEventListener("change", refreshPreview);
      selBloq && selBloq.addEventListener("change", refreshPreview);

      // ‚úÖ Alistar / üîì Cambiar
      btn && btn.addEventListener("click", () => {
        // Si est√° fijado, pasamos a modo edici√≥n (desbloquear) sin borrar el contexto
        if(locked){
          setLocked(false);
          // Persistimos estado desbloqueado
          const raw = localStorage.getItem(KEY_CTX);
          const ctx = raw ? safeParseJSON(raw, null) : null;
          if(ctx){
            try{
              localStorage.setItem(KEY_CTX, JSON.stringify({
                ...ctx,
                locked: false,
                updatedAt: new Date().toISOString()
              }));
            }catch{}
          }
          return;
        }

        // Si NO est√° fijado: validamos y fijamos
        const asignatura = (selAsig.value || "").trim();
        const bloque = (selBloq.value || "").trim();
        if(!asignatura || !bloque){
          alert("Debes seleccionar Asignatura/Grupo y Hora-clase inicio.");
          return;
        }

        // Guardar + Fijar (bloquear selects)
        setLocked(true);
        persistContext();
        refreshPreview();
      });

      // üßπ Borrar contexto
      btnClear && btnClear.addEventListener("click", () => {
        const ok = confirm("¬øBorrar el contexto de sesi√≥n?\n\nEsto NO elimina registros guardados.");
        if(!ok) return;

        try{ localStorage.removeItem(KEY_CTX); }catch{}

        setLocked(false);

        // Reset selects
        if(selAsig) selAsig.value = "";
        if(selBloq) selBloq.value = "";

        refreshPreview();
      });

      cargarContexto();
    })();
  </script>

  <!-- App principal -->
  <script src="./app.20260212-07.js?v=ctxfix2"></script>
</body>
</html>
